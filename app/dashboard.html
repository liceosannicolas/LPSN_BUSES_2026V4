<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AsignaciÃ³n por RUT</title>
  <link rel="stylesheet" href="../assets/css/styles.css"/>
</head>
<body>

<div class="topbar">
  <div class="topbar-inner">
    <div class="brand">
      <div class="logo"></div>
      <div class="brand-title">
        <strong>ğŸ§© Asignar Bus por RUT</strong>
        <small>Transporte Escolar â€¢ Sync oficial</small>
      </div>
    </div>
    <div class="controls">
      <a class="btn ghost" href="../index.html">â¬…ï¸ Volver</a>
      <button class="btn" onclick="TE.speakAll()">ğŸ—£ï¸</button>
      <button class="btn" onclick="TE.toggleTheme()">ğŸŒ“</button>
      <button class="btn" onclick="TE.toggleContrast()">ğŸŒ—</button>
      <button class="btn" onclick="TE.fontUp()">A+</button>
      <button class="btn" onclick="TE.fontDown()">Aâˆ’</button>
      <a class="btn" href="../app/settings.html">âš™ï¸ Sync</a>
    </div>
  </div>
</div>

  <div class="container">
    <div class="two">
      <div class="card">
        <h3>ğŸ” Buscar estudiante</h3>
        <p class="muted">Ingresa el RUT. Se cargan datos desde la hoja â€œEstudiantesâ€ (Sync).</p>
        <div class="row">
          <input class="input" id="rut" placeholder="12.345.678-9 o 12345678-9"/>
          <button class="btn primary" id="btnBuscar">ğŸ” Buscar</button>
        </div>
        <div style="height:10px"></div>
        <div id="studentCard" class="card" style="display:none; margin:0; background: rgba(255,255,255,.04)">
          <div class="kpi">
            <div><strong id="stName">â€”</strong><div class="muted" id="stMeta">â€”</div></div>
          </div>
          <div style="height:8px"></div>
          <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px">
            <div><div class="muted">ğŸ“ Domicilio</div><div id="stDom">â€”</div></div>
            <div><div class="muted">ğŸ« Curso</div><div id="stCurso">â€”</div></div>
            <div><div class="muted">ğŸ™ï¸ Comuna/Zona</div><div id="stComuna">â€”</div></div>
            <div><div class="muted">ğŸ“§ Correo</div><div id="stEmail">â€”</div></div>
          </div>
          <div style="height:10px"></div>
          
          <div style="height:10px"></div>
          <div class="row" style="gap:10px">
            <button class="btn" id="btnEditStudent" onclick="openEdit()">âœï¸ Modificar estudiante</button>
            <button class="btn ghost" id="btnCancelEdit" style="display:none" onclick="closeEdit()">Cancelar</button>
          </div>

          <div id="editPanel" class="card" style="display:none; margin-top:12px; background: rgba(0,0,0,.16); border:1px solid rgba(255,255,255,.10)">
            <h3 style="margin:0 0 10px 0">ğŸ§¾ Editar datos del estudiante</h3>
            <p class="muted small" style="margin-top:0">Completa o corrige informaciÃ³n (domicilio, comuna, etc.). Se guarda en Google Sheets (hoja <code>Estudiantes</code>).</p>

            <div class="two">
              <div>
                <label class="muted">ğŸ‘¤ Nombre (completo)</label>
                <input id="edNombre" placeholder="Ej: Catalina Pascal Almuna SÃ¡ez"/>
              </div>
              <div>
                <label class="muted">ğŸ« Curso</label>
                <input id="edCurso" placeholder="Ej: 7Â°B / 1Â°M"/>
              </div>
              <div>
                <label class="muted">ğŸ“ Domicilio</label>
                <input id="edDom" placeholder="DirecciÃ³n y nÃºmero"/>
              </div>
              <div>
                <label class="muted">ğŸ™ï¸ Comuna</label>
                <input id="edComuna" placeholder="Comuna"/>
              </div>
              <div>
                <label class="muted">ğŸ—ºï¸ Zona</label>
                <input id="edZona" placeholder="Zona / sector"/>
              </div>
              <div>
                <label class="muted">ğŸ“§ Correo</label>
                <input id="edEmail" type="email" placeholder="correo@..."/>
              </div>
            </div>

            <div style="height:10px"></div>
            <div class="row" style="gap:10px">
              <button class="btn" onclick="saveEdit()">ğŸ’¾ Guardar cambios</button>
            </div>
          </div>

          <div class="badge" id="stStatus">Estado: â€”</div>
        </div>
      </div>

      <div class="card">
        <h3>ğŸšŒ Asignar bus</h3>
        <p class="muted">Guarda asignaciÃ³n. El sistema crea/actualiza la hoja del bus: <code>BUS_&lt;ID&gt;</code>. Si se llena, envÃ­a a <code>En_espera</code>.</p>
        <div style="height:8px"></div>
        <label class="muted">Bus</label>
        <select id="busSel"></select>
        <div style="height:10px"></div>
        <label class="muted">Recorrido</label>
        <input class="input" id="recorrido" placeholder="Ej: Sector A â†’ Liceo â†’ Sector B"/>
        <div style="height:10px"></div>
        <div class="row">
          <button class="btn primary" id="btnAsignar">âœ… Guardar asignaciÃ³n</button>
          <button class="btn" id="btnRef">ğŸ”„ Refrescar buses</button>
          <button class="btn danger" id="logout">ğŸšª Salir</button>
        </div>
        <div style="height:12px"></div>
        <div class="card" style="margin:0; background: rgba(255,255,255,.04)">
          <h3>ğŸ“Œ Resultado</h3>
          <p class="muted" id="result">AÃºn sin acciones.</p>
        </div>
      </div>
    </div>

    <div class="section-title">
      <h2>Atajos</h2>
      <div class="row">
        <a class="btn" href="../pages/dashboard_bus.html">ğŸšŒ Dashboard Bus</a>
        <a class="btn" href="../pages/dashboard_curso.html">ğŸ“ Dashboard Curso</a>
        <a class="btn" href="../tools/importer_sync.html">ğŸ“¥ Cargar NÃ³mina</a>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"><strong>Info</strong> â€” <span></span></div>

  <script src="../assets/js/common.js"></script>
  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/api.js"></script>
  <script>
    const user = TE_AUTH.require();
    let currentStudent = null;
    let editing = false;

    function openEdit(){
      if(!currentStudent) return TE.toast("Primero busca un estudiante.", "warn");
      editing = true;
      document.getElementById("editPanel").style.display = "block";
      document.getElementById("btnCancelEdit").style.display = "inline-flex";
      // Prefill
      document.getElementById("edNombre").value = currentStudent.nombre || "";
      document.getElementById("edCurso").value = currentStudent.curso || "";
      document.getElementById("edDom").value = currentStudent.domicilio || "";
      document.getElementById("edComuna").value = currentStudent.comuna || "";
      document.getElementById("edZona").value = currentStudent.zona || "";
      document.getElementById("edEmail").value = currentStudent.email || "";
    }

    function closeEdit(){
      editing = false;
      document.getElementById("editPanel").style.display = "none";
      document.getElementById("btnCancelEdit").style.display = "none";
    }

    async function saveEdit(){
      if(!currentStudent) return TE.toast("Primero busca un estudiante.", "warn");
      try{
        const updates = {
          nombre: document.getElementById("edNombre").value.trim(),
          curso: document.getElementById("edCurso").value.trim(),
          domicilio: document.getElementById("edDom").value.trim(),
          comuna: document.getElementById("edComuna").value.trim(),
          zona: document.getElementById("edZona").value.trim(),
          email: document.getElementById("edEmail").value.trim()
        };
        // No enviar campos vacÃ­os si quieres conservar lo anterior
        // (pero permitimos vaciar si el usuario borra intencionalmente)
        await TE_API.call("updateStudent", { email: user.email, rut: currentStudent.rut, updates });
        TE.toast("âœ… Estudiante actualizado.", "ok");
        closeEdit();
        // recargar ficha
        await buscar();
      }catch(e){
        TE.toast(e.message || "No se pudo actualizar.", "err");
      }
    }


    function normRut(v){
      return (v||"").toUpperCase().replace(/\s+/g,"").replace(/\./g,"");
    }

    async function loadBuses() {
      try {
        const data = await TE_API.call("listBuses", { email: user.email });
        const sel = document.getElementById("busSel");
        sel.innerHTML = "";
        (data.buses||[]).forEach(b => {
          const opt = document.createElement("option");
          opt.value = b.id;
          opt.textContent = "ğŸšŒ " + b.id + " â€” " + (b.nombre||("Bus "+b.id)) + " (cap: " + (b.capacidad || "â€”") + ")";
          opt.dataset.recorrido = b.recorrido || "";
          sel.appendChild(opt);
        });
        if(sel.options.length) {
          document.getElementById("recorrido").value = sel.options[0].dataset.recorrido || "";
        }
        sel.onchange = () => {
          const o = sel.options[sel.selectedIndex];
          document.getElementById("recorrido").value = (o && o.dataset.recorrido) ? o.dataset.recorrido : "";
        };
      } catch(e) {
        TE.toast(e.message, "err");
      }
    }

    async function buscar() {
      const rut = normRut(document.getElementById("rut").value);
      if(!rut) return TE.toast("Ingresa un RUT.", "warn");
      try {
        const data = await TE_API.call("getStudent", { rut: rut, email: user.email });
        currentStudent = data.student;
        const c = document.getElementById("studentCard");
        c.style.display = "block";
        document.getElementById("stName").textContent = currentStudent.nombre || "(Sin nombre)";
        document.getElementById("stMeta").textContent = "RUT: " + currentStudent.rut;
        document.getElementById("stDom").textContent = currentStudent.domicilio || "â€”";
        document.getElementById("stCurso").textContent = currentStudent.curso || "â€”";
        document.getElementById("stComuna").textContent = currentStudent.comuna || currentStudent.zona || "â€”";
        document.getElementById("stEmail").textContent = currentStudent.email || "â€”";
        document.getElementById("stStatus").textContent = "Estado: " + (data.status || "OK");
        TE.toast("Estudiante cargado.", "ok");
      } catch(e) {
        currentStudent = null;
        document.getElementById("studentCard").style.display = "none";
        TE.toast(e.message, "err");
      }
    }

    async function asignar() {
      if(!currentStudent) return TE.toast("Primero busca un estudiante por RUT.", "warn");
      const busId = document.getElementById("busSel").value;
      const recorrido = document.getElementById("recorrido").value.trim();
      if(!busId) return TE.toast("Selecciona un bus.", "warn");
      try {
        const data = await TE_API.call("assignBus", {
          rut: currentStudent.rut,
          busId: busId,
          recorrido: recorrido,
          digitador: user.email,
          email: user.email
        });
        document.getElementById("result").textContent = data.message || "AsignaciÃ³n registrada.";
        if(data.state === "EN_ESPERA") TE.toast("Bus sin cupo: enviado a En_espera.", "warn");
        else TE.toast("AsignaciÃ³n guardada en hoja del bus.", "ok");
      } catch(e) {
        TE.toast(e.message, "err");
      }
    }

    document.getElementById("btnBuscar").onclick = buscar;
    document.getElementById("btnAsignar").onclick = asignar;
    document.getElementById("btnRef").onclick = loadBuses;
    document.getElementById("logout").onclick = () => TE_AUTH.logout();
    document.getElementById("rut").addEventListener("keydown", (ev)=>{ if(ev.key==="Enter") buscar(); });

    loadBuses();
  </script>
</body>
</html>
